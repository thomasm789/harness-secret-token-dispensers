template:
  name: GitLab PAT Dispenser
  identifier: GitLab_PAT_Dispenser
  versionLabel: "1"
  type: SecretManager
  tags: {}
  spec:
    shell: Bash
    delegateSelectors: []
    source:
      type: Inline
      spec:
        script: |-
          set -o pipefail

          gitlab_url="<+secretManager.environmentVariables.gitlab_url>"
          app_id="<+secretManager.environmentVariables.app_id>"
          client_secret="<+secretManager.environmentVariables.client_secret>"
          username="<+secretManager.environmentVariables.username>"
          password="<+secretManager.environmentVariables.password>"
          scopes="<+secretManager.environmentVariables.scopes>"

          echo "Fetching GitLab Personal Access Token..."

          response=$(curl -s -X POST "${gitlab_url}/oauth/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "grant_type=password" \
            --data-urlencode "client_id=${app_id}" \
            --data-urlencode "client_secret=${client_secret}" \
            --data-urlencode "username=${username}" \
            --data-urlencode "password=${password}" \
            --data-urlencode "scope=${scopes}")

          GITLAB_PAT=$(echo "$response" | grep -o '"access_token":"[^"]*' | cut -d'"' -f4)

          if [[ -z "$GITLAB_PAT" ]]; then
            echo "Failed to retrieve GitLab PAT"
            echo "Response: $response"
            exit 1
          fi

          echo "GitLab PAT successfully retrieved."

          secret="$GITLAB_PAT"
    environmentVariables:
      - name: gitlab_url
        type: String
        value: <+input>
      - name: app_id
        type: String
        value: <+input>
      - name: client_secret
        type: String
        value: <+input>
      - name: username
        type: String
        value: <+input>
      - name: password
        type: String
        value: <+input>
      - name: scopes
        type: String
        value: <+input>
    outputVariables: []
    outputAlias:
      key: GITLAB_PAT
      scope: Pipeline
    onDelegate: true
