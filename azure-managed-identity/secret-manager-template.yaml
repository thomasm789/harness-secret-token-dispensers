template:
  name: Azure Managed Identity Token Dispenser
  identifier: Azure_Managed_Identity_Token_Dispenser
  versionLabel: "1"
  type: SecretManager
  tags: {}
  spec:
    shell: Bash
    delegateSelectors: []
    source:
      type: Inline
      spec:
        script: |-
          set -o pipefail

          resource="<+secretManager.environmentVariables.resource>"
          identity_id="<+secretManager.environmentVariables.identity_id>"

          echo "Requesting Azure Managed Identity OAuth Token..."

          if [[ -n "$identity_id" ]]; then
            response=$(curl -s -H "Metadata: true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2019-08-01&resource=$resource&client_id=$identity_id")
          else
            response=$(curl -s -H "Metadata: true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2019-08-01&resource=$resource")
          fi

          ACCESS_TOKEN=$(echo "$response" | grep -o '"access_token":"[^"]*' | cut -d'"' -f4)

          if [[ -z "$ACCESS_TOKEN" ]]; then
            echo "Failed to retrieve Azure Managed Identity token"
            echo "Response: $response"
            exit 1
          fi

          echo "Azure Managed Identity token successfully retrieved."

          secret="$ACCESS_TOKEN"
    environmentVariables:
      - name: resource
        type: String
        value: <+input>
      - name: identity_id
        type: String
        value: <+input>
    outputVariables: []
    outputAlias:
      key: ACCESS_TOKEN
      scope: Pipeline
    onDelegate: true
